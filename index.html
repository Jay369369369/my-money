<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASSET MASTER - å®Œæ•´é€²éšç‰ˆ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    

    <style>
        :root { 
            --pure-black: #000000; --dark-gray: #0d1117; 
            --border: #30363d; --accent-gold: #ffd700;
            --inc-green: #00ff88; --exp-red: #ff4b4b;
        }
        html, body { height: 100%; margin: 0; background-color: var(--pure-black); color: #e0e6ed; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; }
        .optimized-container { width: 85%; max-width: 1600px; margin: 0 auto; padding: 30px 0; flex: 1; display: flex; flex-direction: column; }
        .nav-tabs { border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .nav-link { color: #8b949e; border: none !important; font-weight: 600; padding: 10px 30px; }
        .nav-link.active { color: var(--accent-gold) !important; background: transparent !important; border-bottom: 3px solid var(--accent-gold) !important; }
        .card { background-color: var(--dark-gray); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; }
        .stat-card { border-top: 3px solid var(--accent-gold); padding: 15px; }
        input, select { background: #010409 !important; color: white !important; border: 1px solid var(--border) !important; }
        .btn-gold { background-color: var(--accent-gold); color: black; font-weight: bold; border: none; padding: 10px; }
        
        .expense-item { 
            background: #161b22; border-radius: 8px; padding: 12px 15px; margin-bottom: 8px; 
            display: flex; flex-direction: column; border: 1px solid transparent; transition: 0.2s;
        }
        .expense-item:hover { border-color: #444; background: #1c2128; }
        .item-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .item-memo { font-size: 0.75rem; color: #6e7681; margin-top: 4px; padding-left: 95px; }
        .item-date { font-size: 0.8rem; color: #8b949e; min-width: 85px; font-family: monospace; }
        
        .quick-section-title { font-size: 0.75rem; color: #8b949e; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .quick-btn { font-size: 0.8rem; border: 1px solid var(--border); color: #e0e6ed; padding: 5px 12px; transition: 0.2s; background: #21262d; border-radius: 6px; cursor: pointer; }
        .quick-btn:hover { border-color: var(--accent-gold); background: #30363d; color: var(--accent-gold); }
        .btn-inc { border-left: 4px solid var(--inc-green); }
        .btn-exp { border-left: 4px solid var(--exp-red); }
        .btn-add-custom { border: 1px dashed #555; color: #8b949e; background: transparent; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }

        #quickModal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;
        }
        /* å½ˆçª—èƒŒæ™¯é®ç½©ï¼šç¢ºä¿å…¨è¢å¹•ç½®ä¸­ */
        .custom-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000;
        }
        /* å½ˆçª—ä¸»é«”ï¼šé™åˆ¶é«˜åº¦ä¸¦å…è¨±å…§éƒ¨æ²å‹• */
        .custom-modal-content {
            width: 90%; max-width: 700px; max-height: 80vh;
            background: #1c2128; border: 1px solid var(--border); border-radius: 12px;
            display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        /* è¡¨æ ¼æ²å‹•å€ */
        .custom-modal-body {
            padding: 0; overflow-y: auto; flex: 1;
        }
        .custom-modal-body thead th {
            position: sticky; top: 0; background-color: #2d333b; z-index: 2;
        }
        /* ä¿®æ”¹å¾Œçš„æœ€çµ‚ç‰ˆæœ¬ */
        #main-chart, #life-chart {
            width: 100% !important;
            min-width: 100% !important; /* ä¿ç•™é€™è¡Œï¼Œé˜²æ­¢è¢« Plotly ç¸®å° */
            min-height: 580px;
            flex-grow: 1;               /* ç¢ºä¿åœ¨ flex ä¸‹è‡ªå‹•æ’é–‹ */
            display: block !important;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 16px; /* ç¢ºä¿å­—é«”åœ¨æ‰‹æ©Ÿä¸Šå¤ å¤§ */
            }
            .container {
                width: 100% !important; /* å¼·åˆ¶å¡«æ»¿è¢å¹• */
                box-sizing: border-box;
            }
            input, button {
                width: 100%; /* è®“æŒ‰éˆ•å’Œè¼¸å…¥æ¡†è®Šæˆé•·æ¢ç‹€ï¼Œæ‰‹æŒ‡æ‰å¥½é» */
                height: 44px; /* è˜‹æœå»ºè­°çš„æœ€å°é»æ“Šé«˜åº¦ */
                margin-bottom: 15px;
                font-size: 18px;
            }
        }
    </style>

    <script>
        /* global firebase */
        /* global db */
        /* global auth */
        // ä½ çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB1md9gANnlldBzpi7GtoHfBuyciWEpJZY",
            authDomain: "jayfms-b8bde.firebaseapp.com",
            projectId: "jayfms-b8bde",
            storageBucket: "jayfms-b8bde.firebasestorage.app",
            messagingSenderId: "898098748288",
            appId: "1:898098748288:web:d36aaf53c2ad5694f67f65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–
        let tradeData = [];
        let lifeData = [];
        let customBtns = { inc: ['è–ªè³‡', 'æŠ•è³‡æ”¶å…¥'], exp: ['æˆ¿è²¸', 'é£²é£Ÿ', 'äº¤é€š', 'è»Šè²¸', 'ä¿éšª'] };
        let currentUser = null;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(user => {
            const statusText = document.getElementById('user-status');
            const loginForm = document.getElementById('login-form');
            const logoutBtn = document.getElementById('logout-btn');

            if (user) {
                currentUser = user;
                statusText.innerHTML = `ğŸ‘¤ å·²é€£ç·š: <span style="color:var(--accent-gold)">${user.email}</span>`;
                loginForm.style.display = 'none';
                logoutBtn.style.display = 'block';
                loadDataFromCloud(user.uid);
            } else {
                currentUser = null;
                statusText.innerHTML = "âŒ å°šæœªç™»å…¥";
                loginForm.style.display = 'flex';
                logoutBtn.style.display = 'none';
            }
        });

        // é›²ç«¯åŠŸèƒ½å‡½æ•¸
        async function handleSignUp() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try { await auth.createUserWithEmailAndPassword(email, pass); alert("è¨»å†ŠæˆåŠŸï¼"); } 
            catch(e) { alert("éŒ¯èª¤: " + e.message); }
        }
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); } 
            catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        }
        function handleLogout() { auth.signOut(); }

        // æ ¸å¿ƒåŒæ­¥é‚è¼¯
        async function saveDataToCloud() {
            if (!currentUser) return;
            await db.collection("users").doc(currentUser.uid).set({
                tradeData, lifeData, customBtns, lastUpdate: new Date()
            });
            console.log("â˜ï¸ é›²ç«¯å‚™ä»½æˆåŠŸ");
        }

        async function loadDataFromCloud(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                tradeData = data.tradeData || [];
                lifeData = data.lifeData || [];
                customBtns = data.customBtns || customBtns;
                
                // ä¿®æ”¹é€™è£¡ï¼šç¢ºä¿åŸæœ¬çš„å‡½æ•¸å­˜åœ¨æ‰åŸ·è¡Œï¼Œé¿å…å ±éŒ¯
                if (typeof renderAllButtons === "function") renderAllButtons();
                if (typeof updateAll === "function") updateAll(); 
            } else {
                // ä¿®æ”¹é€™è£¡ï¼šå¦‚æœé‚„æ²’å¯«åˆå§‹åŒ–å‡½æ•¸ï¼Œå…ˆè·³é
                if (typeof resetInitialAsset === "function") resetInitialAsset();
            }
        }
    </script>
</head>
<body>

<div class="optimized-container">
    <div class="optimized-container">
    <div class="card p-3 mb-4 d-flex flex-row justify-content-between align-items-center" style="border-left: 5px solid var(--accent-gold); background: #161b22;">
        <div id="user-status" style="font-size: 0.9rem; color: #8b949e;">â³ æ­£åœ¨é€£ç·š...</div>
        <div id="login-form" style="display: none;">
            <input type="email" id="auth-email" placeholder="ä¿¡ç®±" class="form-control form-control-sm d-inline-block w-auto me-1" style="background:#000; color:#fff; border:1px solid #30363d;">
            <input type="password" id="auth-pass" placeholder="å¯†ç¢¼" class="form-control form-control-sm d-inline-block w-auto me-1" style="background:#000; color:#fff; border:1px solid #30363d;">
            <button onclick="handleLogin()" class="btn btn-warning btn-sm fw-bold" style="background:#ffd700; color:#000;">ç™»å…¥</button>
            <button onclick="handleSignUp()" class="btn btn-outline-light btn-sm ms-1">è¨»å†Š</button>
        </div>
        <button id="logout-btn" onclick="handleLogout()" class="btn btn-outline-danger btn-sm" style="display: none;">ç™»å‡º</button>
    </div>

    <header class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 style="color: var(--accent-gold); margin: 0; letter-spacing: 1px;">ASSET MASTER</h2>
            <div class="small text-muted">å…¨æ–¹ä½äº¤æ˜“ç¸¾æ•ˆèˆ‡é…ç½®è¦åŠƒç³»çµ±</div>
        </div>
        <div class="text-end">
            <button class="btn btn-outline-warning btn-sm me-2" onclick="resetButtons()">é‡ç½®æŒ‰éˆ•é…ç½®</button>
            <button class="btn btn-outline-danger btn-sm me-2" onclick="clearData()">æ¸…é™¤æ•¸æ“š</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="exportJSON()">å‚™ä»½æ•¸æ“š</button>
        </div>
    </header>

    <ul class="nav nav-tabs" id="myTab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#trade-content">ğŸ“ˆ é¸æ“‡æ¬Šç¸¾æ•ˆ</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#life-content">ğŸ  ç”Ÿæ´»æ”¶æ”¯ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#plan-content">âš–ï¸ ç¶œåˆè¦åŠƒç¸½è¦½</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="trade-content">
            <div class="row g-4">
                <div class="col-lg-3">
                    <div class="card p-4">
                        <h6 class="text-center mb-4 text-info">æ•¸æ“šç™»éŒ„</h6>
                        <div class="mb-2">
                            <label class="small text-muted mb-1">æ—¥æœŸå‘¨æœŸ</label>
                            <input type="text" id="tradeWeek" class="form-control" placeholder="01W1">
                        </div>
                        <div class="mb-2">
                            <label class="small text-muted mb-1">å¹³å€‰æç›Š</label>
                            <input type="number" id="tradeGross" class="form-control" placeholder="0" oninput="calculateAutoNet()">
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="small text-muted mb-1">æ‰‹çºŒè²»</label>
                                <input type="number" id="tradeFee" class="form-control" placeholder="0" oninput="calculateAutoNet()">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted mb-1">ç¨…é‡‘</label>
                                <input type="number" id="tradeTax" class="form-control" placeholder="0" oninput="calculateAutoNet()">
                            </div>
                        </div>
                        <div class="mb-4 p-2 rounded" style="background: rgba(255,255,255,0.05); border: 1px dashed #444;">
                            <label class="small text-muted mb-1 d-block">è‡ªå‹•è¨ˆç®—æ·¨æç›Šï¼š</label>
                            <div id="autoNetDisplay" class="h5 m-0" style="color: var(--accent-gold)">$0</div>
                        </div>
                        <button class="btn btn-gold w-100 mb-4" onclick="addTrade()">å„²å­˜æ•¸æ“š</button>
                        <div class="p-3 border border-secondary rounded" style="background: rgba(0,210,255,0.05);">
                            <div class="small text-muted">50% é ç•™ä¿è­‰é‡‘å»ºè­°ï¼š</div>
                            <div id="adviceFund" class="fw-bold text-info fs-5">$0</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-muted m-0">ç¸¾æ•ˆæ¦‚è¦½</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleDetail" onchange="toggleDetailStats()">
                                <label class="form-check-label small text-muted" for="toggleDetail">é¡¯ç¤ºæˆæœ¬æ˜ç´°</label>
                            </div>
                        </div>
                        <div class="row g-3 mb-2">
                            <div class="col-4">
                                <div class="card stat-card">
                                    <div>å¸³æˆ¶ç¸½è³‡ç”¢</div>
                                    <div class="h4 mt-1" id="dispTotal" style="color: var(--accent-gold)">0</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card stat-card">
                                    <div>ç´¯è¨ˆæ·¨æç›Š</div>
                                    <div class="h4 mt-1" id="dispNet">0</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card stat-card">
                                    <div>ç•¶å‰å ±é…¬ç‡</div>
                                    <div class="h4 mt-1" id="dispROI">0%</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3" id="detailStats" style="display: none;">
                            <div class="col-4">
                                <div class="card stat-card" style="border-top-color: #58a6ff;">
                                    <div class="small text-muted">ç´¯è¨ˆå¹³å€‰æç›Š</div>
                                    <div class="h5 mt-1" id="dispGross" style="color: #e0e6ed">0</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card stat-card" style="border-top-color: #ff7b72;">
                                    <div class="small text-muted">ç´¯è¨ˆæ‰‹çºŒè²»</div>
                                    <div class="h5 mt-1" id="dispTotalFee" style="color: #ff7b72">0</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card stat-card" style="border-top-color: #ff7b72;">
                                    <div class="small text-muted">ç´¯è¨ˆç¨…é‡‘</div>
                                    <div class="h5 mt-1" id="dispTotalTax" style="color: #ff7b72">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-0">
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
                            <h6 class="m-0 text-muted">ç¸¾æ•ˆè¶¨å‹¢åœ–</h6>
                            <div class="d-flex align-items-center">
                                <label class="small text-muted me-2">æœˆä»½ç¯©é¸:</label>
                                <select id="monthFilter" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: 125px;" onchange="updateTradeUI()">
                                    <option value="all">å…¨éƒ¨é€±è³‡æ–™</option>
                                    <option value="01">01 æœˆ</option><option value="02">02 æœˆ</option><option value="03">03 æœˆ</option>
                                    <option value="04">04 æœˆ</option><option value="05">05 æœˆ</option><option value="06">06 æœˆ</option>
                                    <option value="07">07 æœˆ</option><option value="08">08 æœˆ</option><option value="09">09 æœˆ</option>
                                    <option value="10">10 æœˆ</option><option value="11">11 æœˆ</option><option value="12">12 æœˆ</option>
                                </select>
                            </div>
                        </div>
                        <div id="main-chart" style="height: 600px;"></div>
                        <div class="mt-3 text-end">
                            <button class="btn btn-outline-info btn-sm" onclick="showHistoryModal()">
                                ğŸ› ï¸ ç®¡ç†æ­·å²æ•¸æ“š / ç·¨è¼¯è³‡æ–™
                            </button>
                        </div>

                        <div id="historyModal" class="custom-modal" style="display:none;">
                            <div class="custom-modal-content">
                                <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                                    <h6 class="m-0 text-info">æ­·å²æ•¸æ“šç®¡ç†</h6>
                                    <button type="button" class="btn-close btn-close-white" onclick="closeHistoryModal()"></button>
                                </div>
                                
                                <div class="custom-modal-body">
                                    <table class="table table-dark table-hover mb-0" style="font-size: 0.9rem;">
                                        <thead>
                                            <tr>
                                                <th class="ps-3">é€±æœŸ</th>
                                                <th>å¹³å€‰</th>
                                                <th>è²»ç”¨</th>
                                                <th>ç¨…é‡‘</th>
                                                <th class="text-center">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historyTableBody">
                                            </tbody>
                                    </table>
                                </div>

                                <div class="p-2 border-top border-secondary text-end">
                                    <button class="btn btn-sm btn-secondary" onclick="closeHistoryModal()">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="life-content">
            <div class="row g-4">
                <div class="col-lg-5">
                    <div class="card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="text-info m-0">æ”¶æ”¯ç®¡ç† <small style="font-size: 0.6rem; color: #666;">(æŒ‰éˆ•å³éµåˆªé™¤)</small></h5>
                            <select id="currentMonth" class="form-select form-select-sm w-auto" onchange="updateAll()">
                                <script>
                                    for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}æœˆ</option>`);
                                </script>
                                <option value="ALL" style="color: var(--accent-gold);">ğŸ“Š å¹´åº¦ç¸½è¨ˆ</option>
                            </select>
                        </div>

                        <div id="quick-input-group">
                            <div class="quick-section-title">æ”¶å…¥é …ç›®</div>
                            <div id="inc-btns" class="d-flex flex-wrap gap-2 mb-3">
                                <button class="btn btn-sm quick-btn btn-add-custom" onclick="openBtnModal('inc')">+ æ–°å¢æ”¶å…¥éˆ•</button>
                            </div>

                            <div class="quick-section-title">æ”¯å‡ºé …ç›® (è‡ªå‹•è½‰è² )</div>
                            <div id="exp-btns" class="d-flex flex-wrap gap-2 mb-4">
                                <button class="btn btn-sm quick-btn btn-add-custom" onclick="openBtnModal('exp')">+ æ–°å¢æ”¯å‡ºéˆ•</button>
                            </div>

                            <div class="input-group mb-2">
                                <input type="date" id="lifeDate" class="form-control" style="flex: 0.7;">
                                <input type="text" id="lifeItem" class="form-control" placeholder="é …ç›®å…§å®¹">
                                <input type="number" id="lifeAmount" class="form-control" placeholder="é‡‘é¡">
                            </div>
                            <div class="input-group mb-4">
                                <input type="text" id="lifeMemo" class="form-control" placeholder="å‚™è¨» (é¸å¡«)">
                                <button class="btn btn-primary" onclick="addLifeItem()">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>
                        
                        <div id="expenseList" style="height: 320px; overflow-y: auto; padding-right: 5px;"></div>
                    </div>
                </div>
                <div class="col-lg-7"><div class="card p-4"><div id="life-chart" style="height: 580px;"></div></div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="plan-content">
            <div class="row g-4 text-center">
                <div class="col-md-4"><div class="card stat-card" style="padding:30px"><div>å¸³æˆ¶è³‡ç”¢</div><h2 id="plan-trade" class="mt-2" style="color: var(--accent-gold)">$0</h2></div></div>
                <div class="col-md-4"><div class="card stat-card" style="padding:30px; border-top-color: var(--exp-red)"><div>é¸å®šæ”¯å‡º</div><h2 id="plan-expense" class="mt-2" style="color: var(--exp-red)">$0</h2></div></div>
                <div class="col-md-4"><div class="card stat-card" style="padding:30px; border-top-color: var(--inc-green)"><div>é ä¼°é¤˜é¡</div><h2 id="plan-net" class="mt-2" style="color: var(--inc-green)">$0</h2></div></div>
                <div class="col-12"><div class="card p-5 mt-2"><h3>è²¡å‹™ç”Ÿå­˜åŠ›</h3><div id="plan-advice" class="display-4 fw-bold text-info">-- å€‹æœˆ</div></div></div>
            </div>
        </div>
    </div>
</div>

<div id="quickModal">
    <div class="card" style="width:90%; max-width:400px; border:1px solid var(--accent-gold); padding:25px; background: var(--dark-gray);">
        <h5 id="modalTitle" class="text-warning mb-4">å¿«é€Ÿè¨˜éŒ„</h5>
        <input type="hidden" id="modalType">
        <input type="hidden" id="modalMode"> <div id="recordFields">
            <div class="mb-3">
                <label class="small text-muted mb-1">æ—¥æœŸ</label>
                <input type="date" id="modalDate" class="form-control">
            </div>
            <div class="mb-3">
                <label class="small text-muted mb-1">é‡‘é¡</label>
                <input type="number" id="modalAmount" class="form-control" placeholder="è«‹è¼¸å…¥é‡‘é¡">
            </div>
            <div class="mb-4">
                <label class="small text-muted mb-1">å‚™è¨»</label>
                <input type="text" id="modalMemo" class="form-control" placeholder="å‚™è¨»å…§å®¹ (é¸å¡«)">
            </div>
        </div>

        <div id="buttonFields" style="display:none;">
            <div class="mb-4">
                <label class="small text-muted mb-1">æŒ‰éˆ•åç¨±</label>
                <input type="text" id="modalBtnName" class="form-control" placeholder="ä¾‹å¦‚ï¼šåŠ æ²¹ã€çé‡‘">
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary flex-grow-1" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-gold flex-grow-1" onclick="handleModalSave()">å„²å­˜</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const defaultBtns = { 
        inc: ['è–ªè³‡', 'æŠ•è³‡æ”¶å…¥'], 
        exp: ['æˆ¿è²¸', 'é£²é£Ÿ', 'äº¤é€š', 'è»Šè²¸', 'ä¿éšª'] 
    };

    tradeData = [];
    lifeData = [];
    customBtns = JSON.parse(JSON.stringify(defaultBtns));
    isUpdating = false;

    window.onload = function() {
        if (tradeData.length === 0) resetInitialAsset();
        
        // ã€æ–°å¢é€™è¡Œã€‘ç¢ºä¿èˆŠè³‡æ–™ä¸€è®€å–é€²ä¾†å°±è‡ªå‹•æŒ‰é€±æ¬¡æ’åº
        recalculateTotals(); 
        
        document.getElementById('currentMonth').value = new Date().getMonth() + 1;
        document.getElementById('lifeDate').valueAsDate = new Date();
        renderAllButtons();
        updateAll();
    };

    function resetInitialAsset() {
        let start = prompt("è«‹è¨­å®šåˆå§‹è³‡ç”¢:", "100000");
        tradeData = [{ week: 'åˆå§‹', net: 0, total: parseFloat(start || 100000) }];
    }

    function updateAll() {
        localStorage.setItem('trades_vFinal', JSON.stringify(tradeData));
        localStorage.setItem('life_vFinal', JSON.stringify(lifeData));
        localStorage.setItem('custom_btns_vFinal', JSON.stringify(customBtns));

        if (typeof saveDataToCloud === "function" && currentUser) {
            console.log("æ­£åœ¨å˜—è©¦æ¨é€åˆ°é›²ç«¯..."); // å¦‚æœé€™è¡Œæ²’å‡ºç¾ï¼Œä»£è¡¨æ²’åŸ·è¡Œåˆ°é€™è£¡
            saveDataToCloud();
        } else {
            console.log("æœªå­˜é›²ç«¯ï¼šå¯èƒ½æœªç™»å…¥æˆ–å‡½æ•¸æœªå®šç¾©", {currentUser, saveDataToCloud});
        }
        updateTradeUI(); updateLifeUI(); updatePlanUI();
    }

    function renderAllButtons() {
        const incContainer = document.getElementById('inc-btns');
        const expContainer = document.getElementById('exp-btns');
        incContainer.querySelectorAll('.quick-btn:not(.btn-add-custom)').forEach(b => b.remove());
        expContainer.querySelectorAll('.quick-btn:not(.btn-add-custom)').forEach(b => b.remove());
        customBtns.inc.forEach(name => incContainer.insertBefore(createBtnElement(name, 'inc'), incContainer.lastElementChild));
        customBtns.exp.forEach(name => expContainer.insertBefore(createBtnElement(name, 'exp'), expContainer.lastElementChild));
    }

    function createBtnElement(name, type) {
        const btn = document.createElement('button');
        btn.className = `btn btn-sm quick-btn ${type === 'inc' ? 'btn-inc' : 'btn-exp'}`;
        btn.innerText = name;
        btn.onclick = () => addQuickLife(name, type);
        btn.oncontextmenu = (e) => {
            e.preventDefault();
            if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€æŒ‰éˆ•ï¼Ÿ`)) {
                customBtns[type] = customBtns[type].filter(b => b !== name);
                renderAllButtons(); updateAll();
            }
        };
        return btn;
    }

    function resetButtons() {
        if(confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰æŒ‰éˆ•æ¢å¾©æˆé è¨­é…ç½®å—ï¼Ÿ")) {
            customBtns = JSON.parse(JSON.stringify(defaultBtns));
            renderAllButtons(); updateAll();
        }
    }

    // --- Modal åˆ‡æ›èˆ‡é‚è¼¯ ---
    function closeModal() { document.getElementById('quickModal').style.display = 'none'; }

    // æ¨¡å¼ 1: è¨˜éŒ„æ”¶æ”¯
    function addQuickLife(name, type) {
        const m = document.getElementById('currentMonth').value;
        if (m === 'ALL') return alert('è«‹å…ˆé¸å–ç‰¹å®šæœˆä»½');
        
        document.getElementById('modalMode').value = 'record';
        document.getElementById('recordFields').style.display = 'block';
        document.getElementById('buttonFields').style.display = 'none';
        
        document.getElementById('modalTitle').innerText = (type === 'inc' ? 'æ”¶å…¥ï¼š' : 'æ”¯å‡ºï¼š') + name;
        document.getElementById('modalType').value = type;
        document.getElementById('modalDate').valueAsDate = new Date();
        document.getElementById('modalAmount').value = '';
        document.getElementById('modalMemo').value = '';
        document.getElementById('quickModal').dataset.itemName = name;
        
        document.getElementById('quickModal').style.display = 'flex';
        document.getElementById('modalAmount').focus();
    }

    // æ¨¡å¼ 2: æ–°å¢æŒ‰éˆ•
    function openBtnModal(type) {
        document.getElementById('modalMode').value = 'button';
        document.getElementById('recordFields').style.display = 'none';
        document.getElementById('buttonFields').style.display = 'block';
        
        document.getElementById('modalTitle').innerText = (type === 'inc' ? 'æ–°å¢æ”¶å…¥æŒ‰éˆ•' : 'æ–°å¢æ”¯å‡ºæŒ‰éˆ•');
        document.getElementById('modalType').value = type;
        document.getElementById('modalBtnName').value = '';
        
        document.getElementById('quickModal').style.display = 'flex';
        document.getElementById('modalBtnName').focus();
    }

    // çµ±ä¸€å„²å­˜å…¥å£
    function handleModalSave() {
        const mode = document.getElementById('modalMode').value;
        const type = document.getElementById('modalType').value;

        if (mode === 'record') {
            const name = document.getElementById('quickModal').dataset.itemName;
            const date = document.getElementById('modalDate').value;
            const memo = document.getElementById('modalMemo').value;
            let amt = parseFloat(document.getElementById('modalAmount').value);
            const m = document.getElementById('currentMonth').value;
            if (isNaN(amt)) return alert('è«‹è¼¸å…¥é‡‘é¡');
            if (type === 'exp') amt = -Math.abs(amt);
            lifeData.push({ id: Date.now(), date: date || new Date().toISOString().split('T')[0], name, amt, month: m, memo });
        } else {
            const btnName = document.getElementById('modalBtnName').value;
            if (!btnName || customBtns[type].includes(btnName)) return alert('åç¨±ç„¡æ•ˆæˆ–å·²å­˜åœ¨');
            customBtns[type].push(btnName);
            renderAllButtons();
        }
        updateAll();
        closeModal();
    }
    // A. é¡¯ç¤º/éš±è—æ˜ç´°åˆ‡æ›
    function toggleDetailStats() {
        const detailRow = document.getElementById('detailStats');
        detailRow.style.display = document.getElementById('toggleDetail').checked ? 'flex' : 'none';
    }

    // B. å³æ™‚è¨ˆç®—æ·¨æç›Šé è¦½
    function calculateAutoNet() {
        const gross = parseFloat(document.getElementById('tradeGross').value) || 0;
        const fee = parseFloat(document.getElementById('tradeFee').value) || 0;
        const tax = parseFloat(document.getElementById('tradeTax').value) || 0;
        const net = gross - fee - tax;
        const display = document.getElementById('autoNetDisplay');
        display.innerText = "$" + net.toLocaleString();
        display.style.color = net >= 0 ? '#00ff88' : '#ff4b4b';
        return net;
    }

    // C. æ›´æ–° UI çµ±è¨ˆæ•¸æ“š (ä¿®æ”¹å¾ŒåŒ…å« 3+3 çµ±è¨ˆ)
    function updateTradeUI() {
        if (!tradeData.length) return;

        const selectedMonth = document.getElementById('monthFilter').value;
        let weeks = [];
        let nets = [];
        let totals = [];
        const startTotal = tradeData[0].total;

        // --- A. æ•¸æ“šè™•ç†é‚è¼¯ (ç¢ºä¿åŒ…å«åˆå§‹é»ï¼Œé˜²æ­¢é»ƒç·šæ‡¸ç©º) ---
        if (selectedMonth === 'yearly_monthly') {
            const monthlyMap = {};
            tradeData.slice(1).forEach(d => {
                const monthStr = d.week.substring(0, 2); 
                if (!monthlyMap[monthStr]) monthlyMap[monthStr] = 0;
                monthlyMap[monthStr] += d.net;
            });

            const sortedMonths = Object.keys(monthlyMap).sort();
            // è£œä¸Šã€Œåˆå§‹ã€é»ï¼Œè®“å¹´åº¦å ±è¡¨é»ƒç·šä¹Ÿå¾æœ€å·¦ä¸‹è§’é–‹å§‹
            weeks = ['åˆå§‹', ...sortedMonths.map(m => m + "æœˆ")];
            nets = [0, ...sortedMonths.map(m => monthlyMap[m])];
            
            let runningTotal = startTotal;
            totals = [startTotal];
            sortedMonths.forEach(m => {
                runningTotal += monthlyMap[m];
                totals.push(runningTotal);
            });
        } else {
            // ç‰¹å®šæœˆä»½ç¯©é¸ï¼šå¼·åˆ¶åŒ…å«ã€Œåˆå§‹ã€é»ï¼Œè§£æ±º 02, 03 æœˆæ‡¸ç©ºå•é¡Œ
            let filteredData = tradeData;
            if (selectedMonth !== 'all') {
                filteredData = tradeData.filter(d => 
                    d.week === 'åˆå§‹' || d.week.startsWith(selectedMonth)
                );
            }
            weeks = filteredData.map(d => d.week);
            nets = filteredData.map(d => d.net);
            totals = filteredData.map(d => d.total);
        }

        // --- B. åŸæœ¬çš„çœ‹æ¿çµ±è¨ˆåŠŸèƒ½ (åš´æ ¼ä¿ç•™ï¼Œä¸ä½œæ›´å‹•) ---
        const currentTotal = tradeData[tradeData.length - 1].total;
        const netSum = currentTotal - startTotal;
        const roi = ((netSum / startTotal) * 100).toFixed(2);
        const totalGross = tradeData.reduce((sum, item) => sum + ((item.net + (item.fee || 0) + (item.tax || 0)) || 0), 0);
        const totalFee = tradeData.reduce((sum, item) => sum + (item.fee || 0), 0);
        const totalTax = tradeData.reduce((sum, item) => sum + (item.tax || 0), 0);

        document.getElementById('dispTotal').innerText = currentTotal.toLocaleString();
        document.getElementById('dispNet').innerText = netSum.toLocaleString();
        document.getElementById('dispROI').innerText = (roi > 0 ? "+" : "") + roi + "%";
        document.getElementById('dispROI').style.color = roi >= 0 ? '#00ff88' : '#ff4b4b';
        document.getElementById('dispGross').innerText = totalGross.toLocaleString();
        document.getElementById('dispTotalFee').innerText = totalFee.toLocaleString();
        document.getElementById('dispTotalTax').innerText = totalTax.toLocaleString();
        document.getElementById('adviceFund').innerText = "$" + (currentTotal * 0.5).toLocaleString();

        // --- C. ç¹ªè£½åœ–è¡¨ (å¼·åˆ¶ X è»¸ç‚º category æ¨¡å¼) ---
        const maxNetAbs = Math.max(...nets.map(Math.abs), 50000); 
        const y1Range = [-maxNetAbs * 1.2, maxNetAbs * 5]; 
        const y2Range = [startTotal + y1Range[0], startTotal + y1Range[1]];
        const gd = document.getElementById('main-chart');
        
        Plotly.newPlot(gd, [
            { x: weeks, y: nets, type: 'bar', name: 'æç›Š', marker: {color: nets.map(n => n >= 0 ? '#00ff88' : '#ff4b4b')} },
            { x: weeks, y: totals, type: 'scatter', mode: 'lines+markers', name: 'å¸³æˆ¶', yaxis: 'y2', line: {color: '#ffd700', width: 3} }
        ], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#ffffff' },
            dragmode: 'pan',
            xaxis: { 
                type: 'category', // ã€è§£æ±ºé—œéµã€‘é˜²æ­¢åˆ»åº¦è®Šæˆ 0, 1, 2
                gridcolor: '#1f2937', 
                range: [-0.5, Math.max(weeks.length - 0.5, 5)], // é–å®šæœ€å·¦é‚Š
                constrain: 'domain' 
            },
            yaxis: { tickformat: ',d', gridcolor: '#1f2937', zerolinecolor: '#ffffff', range: y1Range },
            yaxis2: { overlaying: 'y', side: 'right', tickformat: ',d', gridcolor: 'transparent', range: y2Range },
            margin: { t: 40, b: 40, l: 80, r: 80 }, showlegend: false
        }, { responsive: true, displayModeBar: false, scrollZoom: true });

        // --- D. ä¿ç•™åŸæœ¬çš„ç¸®æ”¾åŒæ­¥èˆ‡é‚Šç•Œé–å®š ---
        gd.removeAllListeners('plotly_relayout');
        gd.on('plotly_relayout', (edata) => {
            if (isUpdating) return;
            let update = {};
            if (edata['xaxis.range[0]'] !== undefined && edata['xaxis.range[0]'] < -0.5) update['xaxis.range[0]'] = -0.5;
            if (edata['yaxis.range[0]'] !== undefined) {
                const l = edata['yaxis.range[0]'], h = edata['yaxis.range[1]'];
                update['yaxis2.range'] = [startTotal + l, startTotal + h];
            } else if (edata['yaxis2.range[0]'] !== undefined) {
                const l = edata['yaxis2.range[0]'], h = edata['yaxis2.range[1]'];
                update['yaxis.range'] = [l - startTotal, h - startTotal];
            }
            if (Object.keys(update).length > 0) { 
                isUpdating = true; 
                Plotly.relayout(gd, update).then(() => isUpdating = false); 
            }
        });

        if (document.getElementById('historyModal').style.display === 'flex') renderHistoryTable();
    }

    // æ–°å¢çš„å³æ™‚è¨ˆç®—é‚è¼¯
    function calculateAutoNet() {
        const gross = parseFloat(document.getElementById('tradeGross').value) || 0;
        const fee = parseFloat(document.getElementById('tradeFee').value) || 0;
        const tax = parseFloat(document.getElementById('tradeTax').value) || 0;
        const net = gross - fee - tax;
        
        const display = document.getElementById('autoNetDisplay');
        display.innerText = "$" + net.toLocaleString();
        display.style.color = net >= 0 ? '#00ff88' : '#ff4b4b';
        return net;
    }

    // ä¿®æ”¹éçš„ addTrade å‡½æ•¸
    function addTrade() {
        const week = document.getElementById('tradeWeek').value;
        const gross = parseFloat(document.getElementById('tradeGross').value) || 0;
        const fee = parseFloat(document.getElementById('tradeFee').value) || 0;
        const tax = parseFloat(document.getElementById('tradeTax').value) || 0;
        const net = gross - fee - tax;
        
        if (!week || document.getElementById('tradeGross').value === "") return;

        
        // é€™è£¡æ–°å¢ fee å’Œ tax çš„ç´€éŒ„
        tradeData.push({ 
            week, 
            net, 
            total: 0,
            fee: fee, // ç´€éŒ„ç´¯è¨ˆç”¨
            tax: tax  // ç´€éŒ„ç´¯è¨ˆç”¨
        });
        
        recalculateTotals();

        updateAll();

        if (typeof renderHistoryTable === "function") {
            renderHistoryTable();
        }
        
        ['tradeWeek', 'tradeGross', 'tradeFee', 'tradeTax'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('autoNetDisplay').innerText = '$0';
    }

    function addLifeItem() {
        const date = document.getElementById('lifeDate').value;
        const name = document.getElementById('lifeItem').value;
        const memo = document.getElementById('lifeMemo').value;
        let amt = parseFloat(document.getElementById('lifeAmount').value);
        const month = document.getElementById('currentMonth').value;
        if (!name || isNaN(amt) || month === 'ALL') return;
        amt = -Math.abs(amt); 
        lifeData.push({ id: Date.now(), date: date || new Date().toISOString().split('T')[0], name, amt, month, memo }); 
        updateAll();
        document.getElementById('lifeItem').value = ''; document.getElementById('lifeAmount').value = ''; document.getElementById('lifeMemo').value = '';
    }

    function deleteLifeItem(id) { lifeData = lifeData.filter(i => i.id !== id); updateAll(); }

    function updateLifeUI() {
        const el = document.getElementById('expenseList');
        const currentM = document.getElementById('currentMonth').value;
        const quickInput = document.getElementById('quick-input-group');
        const gd = document.getElementById('life-chart');
        
        const baseLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#8b949e' },
            xaxis: { 
                gridcolor: '#1f2937', 
                zeroline: false,
                fixedrange: true // é–å®š X è»¸ï¼Œæ»¾è¼ªç¸®æ”¾åªæœƒå½±éŸ¿ Y è»¸
            },
            yaxis: { 
                gridcolor: '#1f2937', 
                zeroline: false,
                tickformat: ',d' 
            },
            margin: { t: 60, b: 60, l: 60, r: 60 },
            dragmode: 'pan' // é è¨­ç‚ºæŠ“å–æ¨¡å¼
        };

        if (currentM === 'ALL') {
            quickInput.style.display = 'none';
            
            // å´é‚Šæ¸…å–®é‚è¼¯
            const summary = {};
            lifeData.forEach(i => { summary[i.name] = (summary[i.name] || 0) + i.amt; });
            const displayData = Object.keys(summary).map(key => ({ name: key, amt: summary[key] }));
            el.innerHTML = displayData.sort((a,b) => a.amt-b.amt).map(i => `
                <div class="expense-item">
                    <div class="item-main">
                        <span>${i.name}</span>
                        <span style="color:${i.amt>=0?'#00ff88':'#ff4b4b'}">${i.amt.toLocaleString()}</span>
                    </div>
                </div>`).join('');            

            // å¹´åº¦é•·æ¢åœ–é‚è¼¯
            const monthlyExp = Array(12).fill(0);
            lifeData.filter(i => i.amt < 0).forEach(i => {
                const mIdx = parseInt(i.month) - 1;
                if(mIdx >= 0 && mIdx < 12) monthlyExp[mIdx] += Math.abs(i.amt);
            });

            const data = [{
                x: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
                y: monthlyExp,
                type: 'bar',
                marker: { color: '#ffd700' },
                hovertemplate: '%{x}<br>æ”¯å‡º: %{y:,.0f}<extra></extra>'
            }];

            Plotly.newPlot(gd, data, { 
                ...baseLayout, 
                title: { text: 'å¹´åº¦æ”¯å‡ºè¶¨å‹¢', font: {color: '#fff'} } 
            }, { 
                responsive: true, 
                displayModeBar: false, 
                scrollZoom: true // é–‹å•Ÿæ»¾è¼ªç¸®æ”¾
            });

        } else {
            // --- ç‰¹å®šæœˆä»½ï¼šå°ˆæ¥­æ¼¸å±¤é›™ç’°åœ– ---
            quickInput.style.display = 'block';
            const filtered = lifeData.filter(i => i.month === currentM).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            // 1. åˆ—è¡¨æ›´æ–° (å·¦ä¸‹è§’éƒ¨åˆ†ï¼šä¿ç•™åŸæœ¬æ”¶å…¥ç¶  #00ff88 / æ”¯å‡ºç´… #ff4b4b)
            el.innerHTML = filtered.map(i => `
                <div class="expense-item">
                    <div class="item-main">
                        <span class="item-date">${i.date ? i.date.substring(5) : ''}</span>
                        <strong style="flex:1; margin-left:10px;">${i.name}</strong>
                        <span style="color:${i.amt>=0?'#00ff88':'#ff4b4b'}">${i.amt.toLocaleString()}</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="deleteLifeItem(${i.id})" style="padding:0 5px;">Ã—</button>
                    </div>
                    ${i.memo ? `<div class="item-memo">ğŸ“ ${i.memo}</div>` : ''}
                </div>`).join('');                

            let incSum = 0, expSum = 0;
            const incItems = {}, expItems = {};
            filtered.forEach(item => {
                const val = Math.abs(item.amt);
                if (item.amt >= 0) { incSum += val; incItems[item.name] = (incItems[item.name] || 0) + val; }
                else { expSum += val; expItems[item.name] = (expItems[item.name] || 0) + val; }
            });

            const labels = ['æ”¶å…¥ç¸½è¨ˆ', 'æ”¯å‡ºç¸½è¨ˆ'];
            const parents = ['', ''];
            const values = [incSum, expSum];
            const ids = ['INC_ROOT', 'EXP_ROOT'];
            
            // 2. é›™ç’°åœ–é¡è‰²è¨­å®šï¼šå…§åœˆæ·±è—èˆ‡æ·±æ©˜
            const colors = ['#0056b3', '#d9480f']; 

            // æ”¶å…¥å­é …ï¼šè—è‰²ç³»æ¼¸å±¤ (HSL 210)
            const incNames = Object.keys(incItems);
            incNames.forEach((name, i) => {
                ids.push('INC_' + name);
                labels.push(name);
                parents.push('INC_ROOT');
                values.push(incItems[name]);
                const lightness = 35 + (i * (40 / Math.max(incNames.length, 1)));
                colors.push(`hsl(210, 85%, ${lightness}%)`); 
            });

            // æ”¯å‡ºå­é …ï¼šæ©˜è‰²ç³»æ¼¸å±¤ (HSL 25)
            const expNames = Object.keys(expItems);
            expNames.forEach((name, i) => {
                ids.push('EXP_' + name);
                labels.push(name);
                parents.push('EXP_ROOT');
                values.push(expItems[name]);
                const lightness = 45 + (i * (35 / Math.max(expNames.length, 1)));
                colors.push(`hsl(25, 95%, ${lightness}%)`);
            });

            // 3. ç¹ªè£½åœ–è¡¨
            Plotly.newPlot(gd, [{
                type: "sunburst",
                ids: ids,
                labels: labels,
                parents: parents,
                values: values,
                branchvalues: "total",
                insidetextorientation: 'horizontal',
                // --- æ–‡å­—æ¨£å¼è¨­å®š ---
                insidetextfont: {
                    color: "#ffffff", // åœ–å…§æ–‡å­—å…¨ç™½
                    size: 18       // å­—é«”å¤§å°è¨­å®šè™•
                },
                marker: {
                    colors: colors,
                    line: { width: 1.5, color: '#0d1117' }
                },
                leaf: { opacity: 0.85 },
                hovertemplate: '<b>%{label}</b><br>é‡‘é¡: $%{value:,.0f}<br>ä½”æ¯”: %{percentParent:.1%}<extra></extra>'
            }], {
                ...baseLayout,
                title: { 
                    text: `<b>${currentM}æœˆ è²¡å‹™æ¬Šé‡åˆ†ä½ˆ</b>`, 
                    font: { color: '#e0e6ed', size: 16 } 
                },
                margin: { t: 40, l: 0, r: 0, b: 0 },
                sunburstcolorway: ["#1f77b4", "#ff7f0e"] 
            }, { 
                responsive: true, 
                displayModeBar: false 
            });
        }
    }

    function updatePlanUI() {
        const tradeTotal = tradeData[tradeData.length - 1]?.total || 0;
        const currentM = document.getElementById('currentMonth').value;
        const filtered = currentM === 'ALL' ? lifeData : lifeData.filter(i => i.month === currentM);
        const expenseSum = filtered.filter(i => i.amt < 0).reduce((a, b) => a + Math.abs(b.amt), 0);
        document.getElementById('plan-trade').innerText = "$" + tradeTotal.toLocaleString();
        document.getElementById('plan-expense').innerText = "$" + expenseSum.toLocaleString();
        const divisor = currentM === 'ALL' ? (expenseSum / 12 || 1) : (expenseSum || 1);
        document.getElementById('plan-net').innerText = "$" + (tradeTotal - expenseSum).toLocaleString();
        document.getElementById('plan-advice').innerText = (tradeTotal / divisor).toFixed(1) + " å€‹æœˆ";
    }

    function clearData() { if (confirm("ç¢ºå®šæ¸…é™¤æ•¸æ“šï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function exportJSON() {
        const blob = new Blob([JSON.stringify({ trades: tradeData, life: lifeData, custom: customBtns })], {type: "application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "AssetBackup.json"; a.click();
    }
    // A. é¡¯ç¤ºèˆ‡é—œé–‰å½ˆçª—
    function showHistoryModal() {
        renderHistoryTable(); // æ‰“é–‹æ™‚å…ˆç•«è¡¨æ ¼
        document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    // B. ç”Ÿæˆè¡¨æ ¼å…§å®¹ (å€’åºé¡¯ç¤ºæœ€æ–°çš„åœ¨ä¸Šé¢)
    function renderHistoryTable() {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        // è·³é index 0 (åˆå§‹è¨­å®š)ï¼Œå…¶é¤˜å€’åºæ’åˆ—
        for (let i = tradeData.length - 1; i >= 1; i--) {
            const d = tradeData[i];
            const gross = d.net + (d.fee || 0) + (d.tax || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-3 align-middle">${d.week}</td>
                <td class="align-middle">${gross.toLocaleString()}</td>
                <td class="align-middle text-muted">${(d.fee || 0).toLocaleString()}</td>
                <td class="align-middle text-muted">${(d.tax || 0).toLocaleString()}</td>
                <td class="text-center">
                    <button class="btn btn-outline-info btn-sm py-0 px-2 me-1" onclick="editTrade(${i})">æ”¹</button>
                    <button class="btn btn-outline-danger btn-sm py-0 px-2" onclick="deleteTrade(${i})">åˆª</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    // C. ç·¨è¼¯åŠŸèƒ½ï¼šå½ˆå›å·¦å´è¼¸å…¥æ¡†ä¸¦é—œé–‰è¦–çª—
    function editTrade(index) {
        const d = tradeData[index];
        const gross = d.net + (d.fee || 0) + (d.tax || 0);
        
        // å¡«å›å·¦å´æ¬„ä½
        document.getElementById('tradeWeek').value = d.week;
        document.getElementById('tradeGross').value = gross;
        document.getElementById('tradeFee').value = d.fee || 0;
        document.getElementById('tradeTax').value = d.tax || 0;
        
        // ç§»é™¤é™£åˆ—ä¸­çš„è©²ç­†èˆŠè³‡æ–™
        tradeData.splice(index, 1);
        
        // æ›´æ–°æ‰€æœ‰ç›¸é—œé€£çš„è¨ˆç®—èˆ‡åœ–è¡¨
        recalculateTotals(); 
        updateAll(); 
        
        // é—œé–‰å½ˆçª—ä¸¦æ»¾å‹•åˆ°é ‚éƒ¨
        closeHistoryModal();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // D. åˆªé™¤åŠŸèƒ½
    function deleteTrade(index) {
        if (confirm(`ç¢ºå®šåˆªé™¤ ${tradeData[index].week} çš„è³‡æ–™å—ï¼Ÿ`)) {
            tradeData.splice(index, 1);
            recalculateTotals();
            updateAll();
            renderHistoryTable(); // é‡æ–°æ•´ç†è¡¨æ ¼é¡¯ç¤º
        }
    }

    // E. æ ¸å¿ƒè¼”åŠ©ï¼šé‡æ–°æ ¡æ­£å¸³æˆ¶ç¸½è³‡ç”¢ (é˜²æ­¢ä¸­é–“åˆªé™¤å°è‡´æ•¸å€¼æ–·è£‚)
    function recalculateTotals() {
        if (tradeData.length <= 1) return;
        const initial = tradeData[0];
        let records = tradeData.slice(1);

        records.sort((a, b) => {
            const getSortKey = (str) => {
                // å¦‚æœæ˜¯ "02"ï¼Œè£œä¸Š ZZZ ç¢ºä¿å®ƒæ’åœ¨è©²æœˆæ‰€æœ‰ W1, W2 ä¹‹å¾Œ
                if (str.length === 2) return str + "WZZZ"; 
                return str;
            };
            return getSortKey(a.week).localeCompare(getSortKey(b.week));
        });

        tradeData = [initial, ...records];
        for (let i = 1; i < tradeData.length; i++) {
            tradeData[i].total = tradeData[i - 1].total + tradeData[i].net;
        }
    }
    // å¼·åˆ¶ç›£è½æ¨™ç±¤é åˆ‡æ›ï¼Œåˆ‡æ›å›ä¾†æ™‚ç«‹åˆ»æ ¡æº–
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
            const tc = document.getElementById('main-chart');
            const lc = document.getElementById('life-chart');
            
            // ä½¿ç”¨ requestAnimationFrame æœƒæ¯” setTimeout æ›´é †æš¢
            // å®ƒæœƒç¢ºä¿åœ¨ç€è¦½å™¨æº–å‚™å¥½ç•«ä¸‹ä¸€å¹€æ™‚æ‰åŸ·è¡Œå°ºå¯¸èª¿æ•´
            window.requestAnimationFrame(() => {
                if (tc && tc.calcdata) Plotly.Plots.resize(tc);
                if (lc && lc.calcdata) Plotly.Plots.resize(lc);
            });
        });
    });
</script>
</body>
</html>